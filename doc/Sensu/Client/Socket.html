<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: Sensu::Client::Socket
  
    &mdash; Documentation by YARD 0.8.7.6
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../';
  framesUrl = "../../frames.html#!Sensu/Client/Socket.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../_index.html">Index (S)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Sensu.html" title="Sensu (module)">Sensu</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Client.html" title="Sensu::Client (module)">Client</a></span></span>
     &raquo; 
    <span class="title">Socket</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: Sensu::Client::Socket
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">EM::Connection</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">EM::Connection</li>
          
            <li class="next">Sensu::Client::Socket</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/sensu/client/socket.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>EventMachine connection handler for the Sensu client“s socket.</p>

<p>The Sensu client listens on localhost, port 3030 (by default), for UDP and
TCP traffic. This allows software running on the host to push check results
(that may contain metrics) into Sensu, without needing to know anything
about Sensu“s internal implementation.</p>

<p>The socket only accepts 7-bit ASCII-encoded data.</p>

<p>Although the Sensu client accepts UDP and TCP traffic, you must be aware of
the UDP protocol limitations. Any data you send over UDP must fit in a
single datagram and you will not receive a response (no confirmation).</p>

<h2 id="label-UDP+Protocol+%3D%3D">UDP Protocol ==</h2>

<p>If the socket receives a message containing whitespace and the string
<tt>“ping”</tt>, it will ignore it.</p>

<p>The socket assumes all other messages will contain a single, complete, JSON
hash. The hash must be a valid JSON check result. Deserialization failures
will be logged at the ERROR level by the Sensu client, but the sender of
the invalid data will not be notified.</p>

<h2 id="label-TCP+Protocol+%3D%3D">TCP Protocol ==</h2>

<p>If the socket receives a message containing whitespace and the string
<tt>“ping”</tt>, it will respond with the message <tt>“pong”</tt>.</p>

<p>The socket assumes any other stream will be a single, complete, JSON hash.
A deserialization failure will be logged at the WARN level by the Sensu
client and respond with the message <tt>“invalid”</tt>. An <tt>“ok”</tt> response
indicates the Sensu client successfully received the JSON hash and will
publish the check result.</p>

<p>Streams can be of any length. The socket protocol does not require any
headers, instead the socket tries to parse everything it has been sent each
time a chunk of data arrives. Once the JSON parses successfully, the Sensu
client publishes the result. After <code>WATCHDOG_DELAY</code> (default is
500 msec) since the most recent chunk of data was received, the agent will
give up on the sender, and instead respond <tt>“invalid”</tt> and close the
connection.</p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="Socket/DataError.html" title="Sensu::Client::Socket::DataError (class)">DataError</a></span>
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="WATCHDOG_DELAY-constant" class="">WATCHDOG_DELAY =
          <div class="docstring">
  <div class="discussion">
    
<p>The number of seconds that may elapse between chunks of data from a sender
before it is considered dead, and the connection is close.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='float'>0.5</span></pre></dd>
      
        <dt id="MODE_ACCEPT-constant" class="">MODE_ACCEPT =
          <div class="docstring">
  <div class="discussion">
    
<p>ACCEPT mode. Append chunks of data to a buffer and test to see whether the
buffer contents are valid JSON.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='symbol'>:ACCEPT</span></pre></dd>
      
        <dt id="MODE_REJECT-constant" class="">MODE_REJECT =
          <div class="docstring">
  <div class="discussion">
    
<p>REJECT mode. No longer receiving data from sender. Discard chunks of data
in this mode, the connection is being closed.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='symbol'>:REJECT</span></pre></dd>
      
    </dl>
  




  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#logger-instance_method" title="#logger (instance method)">- (Object) <strong>logger</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute logger.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#protocol-instance_method" title="#protocol (instance method)">- (Object) <strong>protocol</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute protocol.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#settings-instance_method" title="#settings (instance method)">- (Object) <strong>settings</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute settings.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#transport-instance_method" title="#transport (instance method)">- (Object) <strong>transport</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute transport.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cancel_watchdog-instance_method" title="#cancel_watchdog (instance method)">- (Object) <strong>cancel_watchdog</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Cancel the current connection watchdog.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#parse_check_result-instance_method" title="#parse_check_result (instance method)">- (Object) <strong>parse_check_result</strong>(data) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Parse a JSON check result.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#post_init-instance_method" title="#post_init (instance method)">- (Object) <strong>post_init</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Initialize instance variables that will be used throughout the lifetime of
the connection.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_check_result-instance_method" title="#process_check_result (instance method)">- (Object) <strong>process_check_result</strong>(check) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Process a check result.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_data-instance_method" title="#process_data (instance method)">- (Object) <strong>process_data</strong>(data) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Process the data received.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#publish_check_result-instance_method" title="#publish_check_result (instance method)">- (Object) <strong>publish_check_result</strong>(check) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Publish a check result to the Sensu transport.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_data-instance_method" title="#receive_data (instance method)">- (Object) <strong>receive_data</strong>(data) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method is called whenever data is received.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reset_watchdog-instance_method" title="#reset_watchdog (instance method)">- (Object) <strong>reset_watchdog</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Reset (or start) the connection watchdog.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#respond-instance_method" title="#respond (instance method)">- (Object) <strong>respond</strong>(data) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Send a response to the sender, close the connection, and call post_init().</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#validate_check_result-instance_method" title="#validate_check_result (instance method)">- (Object) <strong>validate_check_result</strong>(check) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Validate check result attributes.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="logger=-instance_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="logger-instance_method">
  
    - (<tt>Object</tt>) <strong>logger</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute logger</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 52</span>

<span class='kw'>def</span> <span class='id identifier rubyid_logger'>logger</span>
  <span class='ivar'>@logger</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="protocol=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="protocol-instance_method">
  
    - (<tt>Object</tt>) <strong>protocol</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute protocol</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 52</span>

<span class='kw'>def</span> <span class='id identifier rubyid_protocol'>protocol</span>
  <span class='ivar'>@protocol</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="settings=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="settings-instance_method">
  
    - (<tt>Object</tt>) <strong>settings</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute settings</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 52</span>

<span class='kw'>def</span> <span class='id identifier rubyid_settings'>settings</span>
  <span class='ivar'>@settings</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="transport=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="transport-instance_method">
  
    - (<tt>Object</tt>) <strong>transport</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute transport</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


52
53
54</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 52</span>

<span class='kw'>def</span> <span class='id identifier rubyid_transport'>transport</span>
  <span class='ivar'>@transport</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="cancel_watchdog-instance_method">
  
    - (<tt>Object</tt>) <strong>cancel_watchdog</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Cancel the current connection watchdog.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


96
97
98
99
100</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 96</span>

<span class='kw'>def</span> <span class='id identifier rubyid_cancel_watchdog'>cancel_watchdog</span>
  <span class='kw'>if</span> <span class='ivar'>@watchdog</span>
    <span class='ivar'>@watchdog</span><span class='period'>.</span><span class='id identifier rubyid_cancel'>cancel</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="parse_check_result-instance_method">
  
    - (<tt>Object</tt>) <strong>parse_check_result</strong>(data) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Parse a JSON check result. For UDP, immediately raise a parser error. For
TCP, record parser errors, so the connection <code>watchdog</code> can
report them.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>data</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>to parse for a check result.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


162
163
164
165
166
167
168
169
170
171
172
173
174</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 162</span>

<span class='kw'>def</span> <span class='id identifier rubyid_parse_check_result'>parse_check_result</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_check'>check</span> <span class='op'>=</span> <span class='const'>MultiJson</span><span class='period'>.</span><span class='id identifier rubyid_load'>load</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_cancel_watchdog'>cancel_watchdog</span>
    <span class='id identifier rubyid_process_check_result'>process_check_result</span><span class='lparen'>(</span><span class='id identifier rubyid_check'>check</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>MultiJson</span><span class='op'>::</span><span class='const'>ParseError</span><span class='comma'>,</span> <span class='const'>ArgumentError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
    <span class='kw'>if</span> <span class='ivar'>@protocol</span> <span class='op'>==</span> <span class='symbol'>:tcp</span>
      <span class='ivar'>@parse_error</span> <span class='op'>=</span> <span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_error'>error</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="post_init-instance_method">
  
    - (<tt>Object</tt>) <strong>post_init</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Initialize instance variables that will be used throughout the lifetime of
the connection. This method is called when the network connection has been
established, and immediately after responding to a sender.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


75
76
77
78
79
80
81</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 75</span>

<span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
  <span class='ivar'>@protocol</span> <span class='op'>||=</span> <span class='symbol'>:tcp</span>
  <span class='ivar'>@data_buffer</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@parse_error</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@watchdog</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='ivar'>@mode</span> <span class='op'>=</span> <span class='const'>MODE_ACCEPT</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_check_result-instance_method">
  
    - (<tt>Object</tt>) <strong>process_check_result</strong>(check) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Process a check result. Set check result attribute defaults, validate the
attributes, publish the check result to the Sensu transport, and respond to
the sender with the message <tt>“ok”</tt>.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>check</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>result to be validated and published.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Socket/DataError.html" title="Sensu::Client::Socket::DataError (class)">DataError</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>if <code>check</code> is invalid.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


150
151
152
153
154
155</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 150</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_check_result'>process_check_result</span><span class='lparen'>(</span><span class='id identifier rubyid_check'>check</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_check'>check</span><span class='lbracket'>[</span><span class='symbol'>:status</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='int'>0</span>
  <span class='id identifier rubyid_validate_check_result'>validate_check_result</span><span class='lparen'>(</span><span class='id identifier rubyid_check'>check</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_publish_check_result'>publish_check_result</span><span class='lparen'>(</span><span class='id identifier rubyid_check'>check</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_respond'>respond</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ok</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_data-instance_method">
  
    - (<tt>Object</tt>) <strong>process_data</strong>(data) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Process the data received. This method validates the data encoding,
provides ping/pong functionality, and passes potential check results on for
further processing.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>data</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>to be processed.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 181</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_data'>process_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_bytes'>bytes</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_char'>char</span><span class='op'>|</span> <span class='id identifier rubyid_char'>char</span> <span class='op'>&gt;</span> <span class='int'>0x80</span> <span class='rbrace'>}</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>socket received non-ascii characters</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_respond'>respond</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>invalid</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ping</span><span class='tstring_end'>&quot;</span></span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>socket received ping</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_respond'>respond</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pong</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>socket received data</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span>
      <span class='symbol'>:data</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_data'>data</span>
    <span class='rbrace'>}</span><span class='rparen'>)</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_parse_check_result'>parse_check_result</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>failed to process check result from socket</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span>
        <span class='symbol'>:data</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_data'>data</span><span class='comma'>,</span>
        <span class='symbol'>:error</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
      <span class='rbrace'>}</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_respond'>respond</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>invalid</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="publish_check_result-instance_method">
  
    - (<tt>Object</tt>) <strong>publish_check_result</strong>(check) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Publish a check result to the Sensu transport.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>check</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>result.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


133
134
135
136
137
138
139
140
141
142</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 133</span>

<span class='kw'>def</span> <span class='id identifier rubyid_publish_check_result'>publish_check_result</span><span class='lparen'>(</span><span class='id identifier rubyid_check'>check</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_payload'>payload</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='symbol'>:client</span> <span class='op'>=&gt;</span> <span class='ivar'>@settings</span><span class='lbracket'>[</span><span class='symbol'>:client</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='comma'>,</span>
    <span class='symbol'>:check</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_check'>check</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='symbol'>:issued</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rparen'>)</span>
  <span class='rbrace'>}</span>
  <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>publishing check result</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span>
    <span class='symbol'>:payload</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_payload'>payload</span>
  <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='ivar'>@transport</span><span class='period'>.</span><span class='id identifier rubyid_publish'>publish</span><span class='lparen'>(</span><span class='symbol'>:direct</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>results</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='const'>MultiJson</span><span class='period'>.</span><span class='id identifier rubyid_dump'>dump</span><span class='lparen'>(</span><span class='id identifier rubyid_payload'>payload</span><span class='rparen'>)</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_data-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_data</strong>(data) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method is called whenever data is received. For UDP, it will only be
called once, the original data length can be expected. For TCP, this method
may be called several times, data received is buffered. TCP connections
require a <code>watchdog</code>.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>data</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>received from the sender.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


210
211
212
213
214
215
216
217
218
219
220
221
222
223</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 210</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='ivar'>@mode</span> <span class='op'>==</span> <span class='const'>MODE_REJECT</span>
    <span class='kw'>case</span> <span class='ivar'>@protocol</span>
    <span class='kw'>when</span> <span class='symbol'>:udp</span>
      <span class='id identifier rubyid_process_data'>process_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='kw'>when</span> <span class='symbol'>:tcp</span>
      <span class='kw'>if</span> <span class='const'>EM</span><span class='period'>.</span><span class='id identifier rubyid_reactor_running?'>reactor_running?</span>
        <span class='id identifier rubyid_reset_watchdog'>reset_watchdog</span>
      <span class='kw'>end</span>
      <span class='ivar'>@data_buffer</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_data'>data</span>
      <span class='id identifier rubyid_process_data'>process_data</span><span class='lparen'>(</span><span class='ivar'>@data_buffer</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reset_watchdog-instance_method">
  
    - (<tt>Object</tt>) <strong>reset_watchdog</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Reset (or start) the connection watchdog.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


103
104
105
106
107
108
109
110
111
112
113</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 103</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reset_watchdog'>reset_watchdog</span>
  <span class='id identifier rubyid_cancel_watchdog'>cancel_watchdog</span>
  <span class='ivar'>@watchdog</span> <span class='op'>=</span> <span class='const'>EM</span><span class='op'>::</span><span class='const'>Timer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='const'>WATCHDOG_DELAY</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='ivar'>@mode</span> <span class='op'>=</span> <span class='const'>MODE_REJECT</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>discarding data buffer for sender and closing connection</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span>
      <span class='symbol'>:data</span> <span class='op'>=&gt;</span> <span class='ivar'>@data_buffer</span><span class='comma'>,</span>
      <span class='symbol'>:parse_error</span> <span class='op'>=&gt;</span> <span class='ivar'>@parse_error</span>
    <span class='rbrace'>}</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_respond'>respond</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>invalid</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="respond-instance_method">
  
    - (<tt>Object</tt>) <strong>respond</strong>(data) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Send a response to the sender, close the connection, and call post_init().</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>data</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>to send as a response.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


87
88
89
90
91
92
93</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 87</span>

<span class='kw'>def</span> <span class='id identifier rubyid_respond'>respond</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@protocol</span> <span class='op'>==</span> <span class='symbol'>:tcp</span>
    <span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_close_connection_after_writing'>close_connection_after_writing</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_post_init'>post_init</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="validate_check_result-instance_method">
  
    - (<tt>Object</tt>) <strong>validate_check_result</strong>(check) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Validate check result attributes.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>check</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>result to validate.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


118
119
120
121
122
123
124
125
126
127
128</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/sensu/client/socket.rb', line 118</span>

<span class='kw'>def</span> <span class='id identifier rubyid_validate_check_result'>validate_check_result</span><span class='lparen'>(</span><span class='id identifier rubyid_check'>check</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_check'>check</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^[\w\.-]+$</span><span class='regexp_end'>/</span></span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>DataError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>check name must be a string and cannot contain spaces or special characters</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_check'>check</span><span class='lbracket'>[</span><span class='symbol'>:output</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>DataError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>check output must be a string</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_check'>check</span><span class='lbracket'>[</span><span class='symbol'>:status</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Integer</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>DataError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>check status must be an integer</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Tue Feb 10 17:09:28 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.1.2).
</div>

  </body>
</html>