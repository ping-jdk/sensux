#!/usr/bin/env ruby

require 'sa-monitoring/config'
require 'amqp'
require 'uuidtools'

#
# Connect to RabbitMQ
#
AMQP.start(:host => CONFIG['rabbitmq']['server']) do

  amq = MQ.new

  result = amq.queue('results')

  #
  # Recieve checks, execute them, and publish results for processing
  #
  CONFIG['client']['subscriptions'].each do |exchange|

    uniq_queue_name = UUIDTools::UUID.random_create.to_s

    amq.queue(uniq_queue_name, :auto_delete => true).bind(amq.fanout(exchange)).subscribe do |check_msg|

      check = JSON.parse(check_msg)

      execute_check = proc do
        output = IO.popen(CONFIG['checks'][check['name']]['command']).gets
        {
          'output' => output,
          'status' => $?.to_i,
          'id' => check['id']
        }.to_json
      end

      send_result = proc do |check_result|
        result.publish(check_result)
      end

      EM.defer(execute_check, send_result)
    end
  end

  #
  # Send keep-alives to a worker
  #
  class OhaiClient < EM::Connection
    def post_init
      send_data('Ohai')
      close_connection_after_writing
    end
  end

  EM.add_periodic_timer(30) do
    EM.connect(CONFIG['workers'].sample, 9000, OhaiClient)
  end
end
