#!/usr/bin/env ruby

require 'sa-monitoring/config'

#
# Connect to RabbitMQ
#
AMQP.start(:host => CONFIG['rabbitmq']['server']) do

  amq = MQ.new

  result = amq.direct('')

  #
  # Recieve checks, execute them, and publish results for processing
  #
  CONFIG['client']['subscriptions'].each do |exchange|

    amq.queue(exchange).bind(amq.fanout(exchange)).subscribe do |check_msg|

      check = JSON.parse(check_msg)

      execute_check = proc do
        output = IO.popen(CONFIG['checks'][check['name']]['command']).gets
        {
          'output' => output,
          'status' => $?.to_i,
          'id' => check['id']
        }.to_json
      end

      send_result = proc do |check_result|
        result.publish(check_result, :routing_key => 'results')
      end

      EM.defer(execute_check, send_result)
    end
  end

  #
  # Send keep-alives to a worker
  #
  class OhaiClient < EM::Connection
    def post_init
      send_data('Ohai')
      close_connection_after_writing
    end
  end

  EM.add_periodic_timer(30) do
    EM.connect(CONFIG['workers'].sample, 9000, OhaiClient)
  end
end
